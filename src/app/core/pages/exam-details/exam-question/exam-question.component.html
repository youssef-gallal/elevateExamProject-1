<ng-container *ngIf="(questions$ | async) as questions">
    <div *ngIf="showQuestions && questions?.length">
        <div class="d-flex justify-content-between mb-3 top-0">
            <p class="text-blue fs-4">Question {{ currentIndex + 1 }} of {{ questions.length }}</p>
        </div>
        <div class="d-flex gap-4 mb-3">
            <span *ngFor="let q of questions; let i = index" [class]="'progress-bullet ' + 
                      (i === currentIndex ? 'active' : '') + 
                      (selectedAnswers[i] ? 'answered' : '')" (click)="currentIndex = i">
            </span>
        </div>
        <div class="mb-4 p-2 border rounded">
            <h3 class="mb-3">
                {{ questions[currentIndex].question }}
            </h3>
            <div class="ms-3">
                <div *ngFor="let ans of questions[currentIndex].answers" class="mb-1">
                    <p-radioButton [name]="'question_' + currentIndex" [value]="ans.key"
                        [(ngModel)]="selectedAnswers[currentIndex]" [inputId]="'ans_' + currentIndex + '_' + ans.key"
                        (onClick)="selectAnswer(currentIndex, ans.key)" class="mx-2">
                    </p-radioButton>
                    <label [for]="'ans_' + currentIndex + '_' + ans.key" class="ms-2">
                        {{ ans.answer }}
                    </label>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-secondary" (click)="prevQuestion()" [disabled]="currentIndex === 0">
                Previous
            </button>
            <button *ngIf="currentIndex !== questions.length - 1" class="btn btn-primary"
                (click)="nextQuestion(questions.length)">
                Next
            </button>
            <button *ngIf="currentIndex === questions.length - 1" class="btn btn-primary"
                (click)="submitAnswers(questions)">
                Submit
            </button>
        </div>
    </div>
    <div *ngIf="showResults" class="results-container">
        <div class="d-flex">
            <div class="circular-progress" [style.--percentage]="scorePercentage">
                <div class="inner-circle">
                    <span class="percentage">{{ scorePercentage }}%</span>
                </div>
            </div>
            <div class="score-breakdown">
                <div class="correct">
                    <span class="label">Correct</span>
                    <span class="count">{{ correctAnswers }}</span>
                </div>
                <div class="incorrect">
                    <span class="label">Incorrect</span>
                    <span class="count">{{ incorrectAnswers }}</span>
                </div>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn btn-secondary" (click)="backToQuestions()">Back</button>
            <button class="btn btn-primary" (click)="reviewAnswers()">Review Answers</button>
        </div>
    </div>
    <div *ngIf="reviewMode" class="review-container">
        <div class="d-flex justify-content-between mb-3">
            <p class="text-blue fs-4">
                Reviewing Incorrect Answers ({{ reviewIndex + 1 }} of {{ incorrectQuestions.length }})
            </p>
        </div>
        <div class="mb-4 p-2 border rounded">
            <h3 class="mb-3">
                {{ incorrectQuestions[reviewIndex].question }}
            </h3>
            <div class="ms-3">
                <div *ngFor="let ans of incorrectQuestions[reviewIndex].answers" class="mb-1">
                    <p-radioButton [name]="'review_' + reviewIndex" [value]="ans.key"
                        [inputId]="'review_ans_' + reviewIndex + '_' + ans.key" [disabled]="true"
                        [ngModel]="getSelectedAnswerForReview(reviewIndex)" class="mx-2" [ngClass]="{
              'correct-answer': ans.key === incorrectQuestions[reviewIndex].correct,
              'incorrect-answer': ans.key === getSelectedAnswerForReview(reviewIndex) && 
                               ans.key !== incorrectQuestions[reviewIndex].correct
            }">
                    </p-radioButton>
                    <label [for]="'review_ans_' + reviewIndex + '_' + ans.key" class="ms-2">
                        {{ ans.answer }}
                    </label>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-secondary" (click)="prevReviewQuestion()" [disabled]="reviewIndex === 0">
                Previous
            </button>
            <button *ngIf="reviewIndex !== incorrectQuestions.length - 1" class="btn btn-primary"
                (click)="nextReviewQuestion()">
                Next
            </button>
            <button *ngIf="reviewIndex === incorrectQuestions.length - 1" class="btn btn-primary"
                (click)="backToResults()">
                Back to Results
            </button>
        </div>
    </div>
</ng-container>